<!DOCTYPE html>
<html>
    <head>
        <link href="../bower_components/polymer/polymer.html" rel="import">
        <link href="../bower_components/paper-tabs/paper-tabs.html" rel="import">
        <link href="../bower_components/paper-material/paper-material.html" rel="import">
        <link href="../bower_components/iron-pages/iron-pages.html" rel="import">
        <link href="../bower_components/paper-card/paper-card.html" rel="import">
        <link href="../bower_components/paper-ripple/paper-ripple.html" rel="import">
        <link href="../bower_components/iron-ajax/iron-ajax.html" rel="import">
        <link href="../bower_components/paper-item/paper-item.html" rel="import">
        <link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
        <link rel="import" href="../bower_components/paper-item/paper-item-body.html">
        <link rel="import" href="../bower_components/paper-fab/paper-fab.html">
        <link rel="import" href="../bower_components/paper-input/paper-textarea.html">


        
    </head>

    <dom-module id="page-song">
        <style>
            .flex-wrap {
                @apply(--layout-horizontal);
                @apply(--layout-wrap);
            }
            #songName{
                font-size: 34px;
                line-height: 34px;
                padding-top: 3%;
                padding-right: 24px;
                padding-bottom: 14px;
                padding-left: 24px;
            }
            #songLyricsNonEditable{
                font-size: 19px;
                padding-top: 3%;
                padding-right: 24px;
                padding-bottom: 14px;
                padding-left: 24px;
                text-align: justify;
                transition: all 0.5s linear;

            }
            #songLyricsEditable{
                transition: all 0.5s linear;
                background-color: #F2F2F2;
                font-size: 19px;
                padding-top: 3%;
                padding-right: 24px;
                padding-bottom: 14px;
                padding-left: 24px;
                text-align: justify;

            }
            paper-fab{
                float: right;
                margin-right: 3%;
            }
            paper-material{
                margin-bottom: 5%;
            }
        </style>
        <template>
            <paper-material elevation="1">
<!--                Si utilisé avec app router-->
<!--                <iron-ajax id="get_content" url="/search/artist/{{artist}}/{{id}}" last-response="{{artist}}" handleAs="json"> </iron-ajax>-->

                <iron-ajax id="get_content" auto url="/search/artist/{{_encodeUri(nameArtist)}}/album/{{_encodeUri(nameAlbum)}}/song/{{_encodeUri(nameSong)}}" last-response="{{artist}}" handleAs="json" on-response="handleResponse"> </iron-ajax>
                
                <iron-ajax id="put_content" method="PUT" content-type="application/json"></iron-ajax>

                
                <div id="songName"> 
                   {{artist.albums.songs.titre}}
                    <paper-fab hidden={{editing}}  icon="icons:create" on-tap="doEdit" class="edit" mini></paper-fab>
                    <paper-fab hidden={{!editing}} icon="icons:done"   on-tap="doEdit" class="done" mini></paper-fab>
                </div>                

                <div id="songLyricsNonEditable" hidden={{editing}} contenteditable=false> </div>
                <div id="songLyricsEditable"  hidden={{!editing}} contenteditable=true> </div>                
            </paper-material>
        </template>
    </dom-module>

    
<script>
  // element registration
  Polymer({
    is: "page-song",
    // add properties and methods on the element's prototype
    properties: {
        artist:{
            type: Object,
            value: {}
        },
        editing: {
	    	type: Boolean,
	    	value: false	
    	},
        lyrics:{
            type:String,
            value:""
        }
    },
    ready: function(){   
        this.$.songLyricsEditable.addEventListener("paste", function(e) {
            e.preventDefault();
            var text = e.clipboardData.getData("text/plain"); 
            text = text.replace(/\n|\r\n|\r/g, "<br>\r\n");
            var cleanText = text.replace(/(<([^>]+)>)/ig, "<br>");//pour échaper éventuellement du html ou script
            this.innerHTML = cleanText;
        });
    },
    _encodeUri : function(titre){
        return encodeURIComponent(titre);
    } ,
    _htmlToText : function(html){
        
        return html.innerHTML;
    },
    handleResponse: function(request) {        
        if(this.editing){
            document.querySelector("#songLyricsEditable").innerHTML = request.detail.xhr.response.albums.songs.lyrics;
        }
        if (!this.editing){
            document.querySelector("#songLyricsNonEditable").innerHTML = request.detail.xhr.response.albums.songs.lyrics;
            document.querySelector("#songLyricsEditable").innerHTML = this.lyrics;
            this.lyrics = document.querySelector("#songLyricsNonEditable").innerHTML;  
        }
    },
    doEdit: function(e){
    	this.editing=!this.editing;
        if(this.editing){  
            this.$.get_content.url ="/search/artist/"+this._encodeUri(this.artist.name)+"/album/"+this._encodeUri(this.artist.albums.titre)+"/song/"+this._encodeUri(this.artist.albums.songs.titre);
            this.$.get_content.generateRequest();
        }
    	if (!this.editing){
            document.querySelector("#songLyricsNonEditable").innerHTML = document.querySelector("#songLyricsEditable").innerHTML.replace(/<div>/g,"<br>").replace(/<\/div>/g,"").replace(/\n/g,""); 
            if(this.lyrics != document.querySelector("#songLyricsNonEditable").innerHTML){
                console.log("Des modifications");
                this.lyrics = document.querySelector("#songLyricsNonEditable").innerHTML;
                var objLyrics = {};
                objLyrics.lyrics = this.lyrics;
                objLyrics._id = this.artist.albums.songs._id;
                this.$.put_content.body = JSON.stringify(objLyrics);
                this.$.put_content.url = "/search/artist/"+this._encodeUri(this.artist.name)+"/album/"+this._encodeUri(this.artist.albums.titre)+"/song/"+this._encodeUri(this.artist.albums.songs.titre);
                this.$.put_content.generateRequest();
            }
            else{
                console.log("Pas de modifications");
            }
        }
	},
 
      
  });  

</script>   
</html>
    
