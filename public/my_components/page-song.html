<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<!--my_components-->
<link rel="import" href="show-dialog.html">

<dom-module id="page-song">
   <template>
        <style>
            .flex-wrap {
                @apply(--layout-horizontal);
                @apply(--layout-wrap);
            }
            #songName{
                font-size: 34px;
                line-height: 34px;
            }
            #songLyricsNonEditable,#songLyricsEditable,#songName,#songInfos{
                padding-top: 3%;
                padding-right: 24px;
                padding-bottom: 14px;
                padding-left: 24px;
                text-align: justify;

            }
            nav{
                padding: 3%;
            }
            nav>a{
                margin-right: 5px;
                margin-left: 5px;
            }
            #songLyricsNonEditable,#songLyricsEditable,#songInfos{
                font-size: 19px;
            }
            #songLyricsEditable{
                background-color: #F2F2F2;
            }
            paper-fab{
                float: right;
                margin-right: 3%;
            }
            paper-material{
                margin-bottom: 5%;
            }
        </style>
            <paper-material elevation="1">
                <iron-ajax id="get_content" auto url="/search/artist/{{_encodeUri(nameArtist)}}/album/{{_encodeUri(nameAlbum)}}/song/{{_encodeUri(nameSong)}}" last-response="{{artist}}" handleAs="json" on-response="handleResponse"> </iron-ajax>
                <iron-ajax id="put_content" method="PUT" content-type="application/json"></iron-ajax>
                                        
                <template is="dom-if" if="{{artist.albums.songs.rdf.length}}">
                    <show-dialog labeldialog="RDF {{artist.albums.songs.titre}} :" labelbutton="Show RDF" content="{{artist.albums.songs.rdf}}" labelexitdialog="Close"></show-dialog>
                </template>
                
                <section id="songName"> 
                   {{artist.albums.songs.titre}} 
                    <paper-fab hidden={{editing}}  icon="icons:create" on-tap="doEdit" class="edit" mini></paper-fab>
                    <paper-fab hidden={{!editing}} icon="icons:done"   on-tap="doEdit" class="done" mini></paper-fab>
                </section>    
<!--                Faire un boucle + changer <article> et <p>-->
                    <section id="songInfos"> 
                        <template is="dom-if" if="{{artist.albums.songs.runtime.length}}">
                            <article>Runtime: {{artist.albums.songs.runtime}}</article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.format.length}}">
                            <article>Format: {{artist.albums.songs.format}}</article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.genre.length}}">
                            <article>Genre: {{artist.albums.songs.genre}}</article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.producer.length}}">
                            <article>Producer: {{artist.albums.songs.producer}}</article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.recordLabel.length}}">
                            <article>RecordLabel: {{artist.albums.songs.recordLabel}}</article>
                        </template>                        
                        <template is="dom-if" if="{{artist.albums.songs.writer.length}}">
                            <article>Writer: {{artist.albums.songs.writer}}</article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.recorded.length}}">
                            <article>Recorded: {{artist.albums.songs.recorded}}</article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.releaseDate.length}}">
                            <article>Release Date: {{artist.albums.songs.releaseDate}}</article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.award.length}}">
                            <article>Award: {{artist.albums.songs.award}}</article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.abstract.length}}">
                            <p>Abstract: {{artist.albums.songs.abstract}}</p>
                        </template>
                    </section>  
          
                <section>
                    <article id="songLyricsNonEditable" hidden={{editing}} contenteditable=false> </article>
                    <article id="songLyricsEditable"  hidden={{!editing}} contenteditable=true> </article> 
                </section> 
                <nav>
                    <template is="dom-if" if="{{artist.albums.songs.subject.length}}">
                        <template is="dom-repeat" items="{{artist.albums.songs.subject}}" as="subject">
                            <a href="#/search/category/song/{{subject}}"> {{subject}}</a>
                        </template>
                    </template>
                </nav>                
            </paper-material>
        </template>

    
<script>
  // element registration
  Polymer({
    is: "page-song",
    // add properties and methods on the element's prototype
    properties: {
        artist:{
            type: Object,
            value: {}
        },
        editing: {
	    	type: Boolean,
	    	value: false	
    	},
        lyrics:{
            type:String,
            value:""
        }
    },
    ready: function(){   
        //Fonction permettant de réagir a un coller dans la zone prévu pour les lyrics
        this.$.songLyricsEditable.addEventListener("paste", function(e) {
            e.preventDefault();
            var text = e.clipboardData.getData("text/plain"); 
            text = text.replace(/\n|\r\n|\r/g, "<br>");
            var cleanText = text.replace(/(<([^>]+)>)/ig, "<br>");//pour échapper éventuellement du html ou script
            this.innerHTML = cleanText;
        });
    },
    _encodeUri : function(titre){
        return encodeURIComponent(titre);
    },
    //Cette fonction est utilisé lorsque l'utilisateur charge la page et lorsqu'il clique sur le bouton de modification des lyrics
    handleResponse: function(request) {        
        //Si l'utilisateur clique sur le bouton de modification des lyrics
        if(this.editing){
            //On ajoute via innerHTML car nous récupérons du HTML en base de données (des balises <br>) cela nous permet de garder la mise en page
            this.$.songLyricsEditable.innerHTML = request.detail.xhr.response.albums.songs.lyrics;
        }
        //Si l'utilisateur clique sur le bouton pour enregistrer sa modification des lyrics ou que l'utilisateur charge la page
        else{
            this.$.songLyricsNonEditable.innerHTML = request.detail.xhr.response.albums.songs.lyrics;
            this.$.songLyricsEditable.innerHTML = this.lyrics;
            this.lyrics = this.$.songLyricsNonEditable.innerHTML
        }
    },
    //Lorsque l'utilisateur clique sur le bouton de modification ou de sauvegarde
    doEdit: function(e){
    	this.editing=!this.editing;
        if(this.editing){  
            this.$.get_content.url ="/search/artist/"+this._encodeUri(this.artist.name)+"/album/"+this._encodeUri(this.artist.albums.titre)+"/song/"+this._encodeUri(this.artist.albums.songs.titre);
            this.$.get_content.generateRequest();
        }
    	if (!this.editing){
            //On replace dans un premier temps les <div> et <p> par des br car ces élements sont utilisés par les navigateurs pour les sauts de ligne dans un contenteditable
            //on supprime ensuite les retours chariots et les autres tags HTML
            this.$.songLyricsNonEditable.innerHTML = this.$.songLyricsEditable.innerHTML.replace(/<div>|<p>/ig,"<br>").replace(/\\n|\\r|\\r\\n|(<((?!br)[^>]+)>)/ig,"");
            if(this.lyrics != this.$.songLyricsNonEditable.innerHTML){
                console.log("Des modifications");
                this.lyrics = this.$.songLyricsNonEditable.innerHTML;
                var objLyrics = {};
                objLyrics.lyrics = this.lyrics;
                objLyrics._id = this.artist.albums.songs._id;
                //Construction du body pour l'envoie
                this.$.put_content.body = JSON.stringify(objLyrics);
                //Construction de la requête
                this.$.put_content.url = "/search/artist/"+this._encodeUri(this.artist.name)+"/album/"+this._encodeUri(this.artist.albums.titre)+"/song/"+this._encodeUri(this.artist.albums.songs.titre);
                //On lance la requête
                this.$.put_content.generateRequest();
            }
            else{
                console.log("Pas de modifications");
            }
        }
	},
 
      
  });  

</script>   
</dom-module>
