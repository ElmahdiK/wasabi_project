<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<!--<link rel="import" href="MT5/index-mt5.html">-->



<!--my_components-->
<link rel="import" href="show-dialog.html">

<dom-module id="page-song">
   <template>
        <style>
            paper-tab{
                --paper-tab-ink :#E0E0E0;
            }
            paper-tab:hover{
                background-color: #f2f2f2;
            }
            paper-tabs {
                --paper-tabs-selection-bar-color:#3f51b5;
            }
            #songLyricsNonEditable,#songLyricsEditable,#songName,#songInfos{
                padding-top: 3%;
                padding-right: 24px;
                padding-bottom: 14px;
                padding-left: 24px;
                text-align: justify;
            }
            paper-button{
                padding: 0;
                margin :0;
            }
            .song{
                font-size: 2em;
                font-weight: 400;
                line-height: 28px;
            }
            nav{
                padding: 3%;
            }
            nav>a{
                margin-right: 5px;
                margin-left: 5px;
            }
            #songLyricsNonEditable,#songLyricsEditable,#songInfos{
                font-size: 19px;
            }
            #songLyricsEditable{
                background-color: #F2F2F2;
            }
            paper-fab{
                float: right;
                margin-right: 3%;
            }
            paper-input{
                font-size: 12px;
            }
            paper-material{
                margin-bottom: 5%;
            }
            .inherit {
                color: inherit;
                background-color: inherit;
            }
        </style>
        <paper-material elevation="1">
            <!--permet de lancer automatiquement la requête get chargeant la page-->
            <iron-ajax id="get_content_auto" auto url="/search/artist/{{_encodeUri(nameArtist)}}/album/{{_encodeUri(nameAlbum)}}/song/{{_encodeUri(nameSong)}}" last-response="{{artist}}" handleAs="json" on-response="handleResponse"> </iron-ajax>
            <!--permet de faire des requêtes get permettant de recupérer les données avant modification-->
            <iron-ajax id="get_content" last-response="{{artist}}" handleAs="json" on-response="handleResponse"> </iron-ajax>
            <!--permet de faire des requêtes de modification-->
            <iron-ajax id="put_content" method="PUT" content-type="application/json"></iron-ajax>

            <paper-tabs selected="{{idxCurrentTab}}">
                <paper-tab>Lyrics</paper-tab>
                <paper-tab>MT5</paper-tab>
            </paper-tabs>

            <iron-pages selected="{{idxCurrentTab}}">
                <div>
                    <template is="dom-if" if="{{artist.albums.songs.rdf.length}}">
                        <show-dialog labeldialog="RDF {{artist.albums.songs.titre}} :" labelbutton="Show RDF" content="{{artist.albums.songs.rdf}}" labelexitdialog="Close"></show-dialog>
                    </template>
                    <section id="songName">
                        <div class="song">
                            <a href="#/search/more/{{_concat(artist.name,artist.albums.songs.titre)}}"  tabindex="-1" class="inherit" > <!--hidden="{{editing}}"-->
                                <paper-button tabindex="0" role="button" elevation="0">{{artist.albums.songs.titre}}</paper-button>
                            </a>
                            <!--                        <paper-input label="titre: {{song.titre}}" id="edit_song" hidden="{{!editing}}" value="{{artist.albums.songs.titre}}"></paper-input>-->
                        </div>
                        <div>
                            <a href="#/search/artist/{{_encodeUri(artist.name)}}" tabindex="-1" class="inherit" >
                                <paper-button tabindex="0" role="button" elevation="0">Artist: {{artist.name}}</paper-button>
                            </a>
                        </div>
                        <div>
                            <a href="#/search/artist/{{_encodeUri(artist.name)}}/album/{{_encodeUri(artist.albums.titre)}}" tabindex="-1" class="inherit" >
                                <paper-button tabindex="0" role="button" elevation="0" >Album: {{artist.albums.titre}}</paper-button>
                            </a>
                        </div>
                    </section>
                    <paper-fab hidden={{editing}}  icon="icons:create" on-tap="doEdit" class="edit" mini></paper-fab>
                    <paper-fab hidden={{!editing}} icon="icons:done"   on-tap="doEdit" class="done" mini></paper-fab>
                    <!--                Faire un boucle + changer <article> et <p>-->
                    <section id="songInfos">
                        <template is="dom-if" if="{{artist.albums.songs.runtime.length}}">
                            <article>Runtime: {{artist.albums.songs.runtime}}</article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.format.length}}">
                            <article>Format: {{artist.albums.songs.format}}</article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.genre.length}}">
                            <article>Genre: {{artist.albums.songs.genre}}</article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.producer.length}}">
                            <article>Producer: {{artist.albums.songs.producer}}</article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.recordLabel.length}}">
                            <article>RecordLabel: {{artist.albums.songs.recordLabel}}</article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.writer.length}}">
                            <article>Writer: {{artist.albums.songs.writer}}</article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.recorded.length}}">
                            <article>Recorded: {{artist.albums.songs.recorded}}</article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.releaseDate.length}}">
                            <article>Release Date: {{artist.albums.songs.releaseDate}}</article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.award.length}}">
                            <article>Award: {{artist.albums.songs.award}}</article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.abstract.length}}">
                            <p>Abstract: {{artist.albums.songs.abstract}}</p>
                        </template>
                    </section>

                    <section id="songLyricsSection">
                        <article id="songLyricsNonEditable" hidden={{editing}} contenteditable=false> </article>
                        <article id="songLyricsEditable"  hidden={{!editing}} contenteditable=true> </article>
                    </section>
                    <nav>
                        <template is="dom-if" if="{{artist.albums.songs.subject.length}}">
                            <template is="dom-repeat" items="{{artist.albums.songs.subject}}" as="subject">
                                <a href="#/search/category/song/{{subject}}"> {{subject}}</a>
                            </template>
                        </template>
                    </nav>
                </div>
                <div>
                    <iframe style="width:100%; height:1000px" src="MT5/index.html">
                    </iframe>
                </div>
            </iron-pages>
        </paper-material>
    </template>
<script>
  // element registration
  Polymer({
    is: "page-song",
    // add properties and methods on the element's prototype
    properties: {
        artist:{
            type: Object,
            value: {}
        },
        idxCurrentTab:{
            type:Number,
            value:0,
        },
        editing: {
	    	type: Boolean,
	    	value: false	
    	}
    },
    ready: function(){
        //Fonction permettant de réagir a un coller dans la zone prévu pour les lyrics
        this.$.songLyricsEditable.addEventListener("paste", function(e) {
            e.preventDefault();
            var text = e.clipboardData.getData("text/plain"); 
            text = text.replace(/\n|\r\n|\r/g, "<br>");
            var cleanText = text.replace(/(<([^>]+)>)/ig, "<br>");//pour échapper éventuellement du html ou script
            this.innerHTML = cleanText;
        });
    },
    _encodeUri : function(titre){
        return encodeURIComponent(titre);
    },
    //Cette fonction est utilisé lorsque l'utilisateur charge la page et lorsqu'il clique sur le bouton de modification des lyrics
    handleResponse: function(request) { 
        console.log("DANS handleResponse");
        //Si l'utilisateur clique sur le bouton de modification des lyrics
        if(this.editing){
            //On ajoute via innerHTML els lyrics car nous récupérons du HTML en base de données (des balises <br>) cela nous permet de garder la mise en page
            //Nous ne pouvons donc pas bind les lyrics directement dans le html
            this.$.songLyricsEditable.innerHTML = this.artist.albums.songs.lyrics;
        }
        //Si l'utilisateur l'utilisateur charge
        else{
            this.$.songLyricsNonEditable.innerHTML = this.artist.albums.songs.lyrics;
            /*On rempli le contenu éditable cela permet de ne pas avoir des lyrics vide lors de l'attente de la reponse ajax*/
            this.$.songLyricsEditable.innerHTML = this.artist.albums.songs.lyrics;
        }
    },
    _concat: function(str1,str2){
        return this._encodeUri(str1+' '+str2);
    },
    //Lorsque l'utilisateur clique sur le bouton de modification ou de sauvegarde
    doEdit: function(e){
    	this.editing=!this.editing;
        //lorsque l'utilisateur clique sur l'icone de modification
        if(this.editing){  
            //this.$.get_content.url ="/search/artist/"+this._encodeUri(this.artist.name)+"/album/"+this._encodeUri(this.artist.albums.titre)+"/song/"+this._encodeUri(this.artist.albums.songs.titre);
            //on récupére les infos en fonction de l'id de l'artiste/album/musique
            this.$.get_content.url ="/search/artist_id/"+this.artist._id+"/album_id/"+this.artist.albums._id+"/song_id/"+this.artist.albums.songs._id;
            this.$.get_content.generateRequest();
        }
        //Si l'utilisateur veut enregistrer ses modifications
    	else{
            //On replace dans un premier temps les <div> et <p> par des br car ces élements (<div> et <p>) sont utilisés par les navigateurs pour les sauts de ligne dans un contenteditable
            //On supprime ensuite les retours chariots et les autres tags HTML de l'utilisateur
            this.$.songLyricsNonEditable.innerHTML = this.$.songLyricsEditable.innerHTML.replace(/<div>|<p>/ig,"<br>").replace(/\\n|\\r|\\r\\n|(<((?!br)[^>]+)>)/ig,"");
            //Construction du body pour l'envoie
            this.artist.albums.songs.lyrics = this.$.songLyricsNonEditable.innerHTML;
            this.$.put_content.body = JSON.stringify(this.artist.albums.songs);
            //Construction de la requête
            this.$.put_content.url = "/search/artist/"+this._encodeUri(this.artist.name)+"/album/"+this._encodeUri(this.artist.albums.titre)+"/song/"+this._encodeUri(this.artist.albums.songs.titre);
            //On lance la requête
            this.$.put_content.generateRequest();
              //Si des modifications on eu lieu alors il faudra envoyé la requête ajax
//            if(this.artist.albums.songs.lyrics != this.$.songLyricsNonEditable.innerHTML){
//                console.log("Des modifications"); } else{console.log("Pas de modifications");}
        }
	},
 
      
  });  

</script>   
</dom-module>
