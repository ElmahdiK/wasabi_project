<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/google-youtube/google-youtube.html">
<!--<link rel="import" href="MT5/index-mt5.html">-->



<!--my_components-->
<link rel="import" href="show-dialog.html">

<dom-module id="page-song">
    <template>
        <style>
            paper-tab{
                --paper-tab-ink :#E0E0E0;
            }
            paper-tab:hover {
                background-color: #f2f2f2;
            }
            .isClassic{
                color:#ffe52f;
                width:50px;
                height:50px;
                float: right;
            }
            .inline{
                display: inline-block;
            }
            paper-tabs {
                --paper-tabs-selection-bar-color:#3f51b5;
            }
            #songLyricsNonEditable,#songLyricsEditable,#songName,#songInfos{
                padding-top: 3%;
                padding-right: 24px;
                padding-bottom: 14px;
                padding-left: 24px;
                text-align: justify;
            }
            paper-button{
                padding: 0;
                margin :0;
            }
            .song{
                font-size: 2em;
                width: 100%;
            }
            nav{
                padding: 3%;
            }
            nav>a{
                margin-right: 5px;
                margin-left: 5px;
            }
            #songLyricsNonEditable,#songLyricsEditable,#songInfos{
                font-size: 19px;
            }
            #songLyricsEditable{
                background-color: #F2F2F2;
            }
            paper-fab{
                float: right;
                margin-right: 3%;
            }
            paper-input{
                font-size: 12px;
            }
            paper-material{
                margin-bottom: 5%;
            }
            .inherit {
                color: inherit;
                background-color: inherit;
                text-decoration:none;
            }
            .urlMargin{
                margin-right: 5px;
            }
        </style>
        <paper-material elevation="1">
            <!--permet de lancer automatiquement la requête get chargeant la page-->
            <iron-ajax id="get_content_auto" auto url="/search/artist/{{_encodeUri(nameArtist)}}/album/{{_encodeUri(nameAlbum)}}/song/{{_encodeUri(nameSong)}}" last-response="{{artist}}" handleAs="json" on-response="handleResponse"> </iron-ajax>
            <!--permet de faire des requêtes get permettant de recupérer les données avant modification-->
            <iron-ajax id="get_content" last-response="{{artist}}" handleAs="json" on-response="handleResponse"> </iron-ajax>
            <!--permet de faire des requêtes de modification-->
            <iron-ajax id="put_content" method="PUT" content-type="application/json"></iron-ajax>

            <!--Ce dom-if sert uniquement a ne pas avoir de problème d'affichage sur la selection du paper-tab (uniquement sur les musiques ayant du multitrack)-->
            <template is="dom-if" if="{{artist}}">
                <paper-tabs selected="{{idxCurrentTab}}">
                    <paper-tab>Lyrics</paper-tab>
                    <template is="dom-if" if="{{artist.albums.songs.multitrack_path.length}}">
                        <paper-tab>Multitracks</paper-tab>
                    </template>
                </paper-tabs>
            </template>

            <iron-pages selected="{{idxCurrentTab}}">
                <div>
                    <template is="dom-if" if="{{artist.albums.songs.rdf.length}}">
                        <show-dialog labeldialog="RDF {{artist.albums.songs.title}} :" labelbutton="Show RDF" content="{{artist.albums.songs.rdf}}" labelexitdialog="Close"></show-dialog>
                    </template>
                    <section id="songName">
                        <div class="song inline">
                            <a href="#/search/more/{{_concat(artist.name,artist.albums.songs.title)}}"  tabindex="-1" class="inherit" > <!--hidden="{{editing}}"-->
                                <paper-button tabindex="0" role="button" elevation="0">{{artist.albums.songs.title}}</paper-button>
                            </a>
                            <template is="dom-if" if="{{artist}}">
                                <paper-icon-button on-tap="doIsClassic" class="isClassic" icon="star-border" hidden$="{{artist.albums.songs.isClassic}}" ></paper-icon-button>
                                <paper-icon-button on-tap="doIsClassic" class="isClassic" icon="star" hidden$="{{!artist.albums.songs.isClassic}}"></paper-icon-button>
                            </template>

                        </div>
                        <div>
                            <a href="#/search/artist/{{_encodeUri(artist.name)}}" tabindex="-1" class="inherit" >
                                <paper-button tabindex="0" role="button" elevation="0">Artist: {{artist.name}}</paper-button>
                            </a>
                        </div>
                        <div>
                            <a href="#/search/artist/{{_encodeUri(artist.name)}}/album/{{_encodeUri(artist.albums.title)}}" tabindex="-1" class="inherit" >
                                <paper-button tabindex="0" role="button" elevation="0" >Album: {{artist.albums.title}}</paper-button>
                            </a>
                        </div>
                    </section>
                    <!--                Faire un boucle + changer <article> et <p>-->

                    <section id="songInfos">
                        <template is="dom-if" if="{{artist.albums.songs.urlYoutube.length}}">
                            <google-youtube video-id="{{artist.albums.songs.urlYoutube}}" height="270px" width="480px"></google-youtube>
                        </template>


                        <template is="dom-if" if="{{artist.albums.songs.urlSpotify.length}}">
                            <a class="urlMargin" href="{{artist.albums.songs.urlSpotify}}">Spotify</a>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.urlMusicBrainz.length}}">
                            <a class="urlMargin" href="{{artist.albums.songs.urlMusicBrainz}}">MusicBrainz</a>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.urlITunes.length}}">
                            <a class="urlMargin" href="{{artist.albums.songs.urlITunes}}">iTunes</a>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.urlAllmusic.length}}">
                            <a class="urlMargin" href="{{artist.albums.songs.urlAllmusic}}">Allmusic</a>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.urlLastFm.length}}">
                            <a class="urlMargin" href="{{artist.albums.songs.urlLastFm}}">LastFm</a>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.urlPandora.length}}">
                            <a class="urlMargin" href="{{artist.albums.songs.urlPandora}}">Pandora</a>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.urlAmazon.length}}">
                            <a class="urlMargin" href="{{artist.albums.songs.urlAmazon}}">Amazon</a>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.urlGoEar.length}}">
                            <a class="urlMargin" href="{{artist.albums.songs.urlGoEar}}">GoEar</a>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.urlHypeMachine.length}}">
                            <a class="urlMargin" href="{{artist.albums.songs.urlHypeMachine}}">Hype Machine</a>
                        </template>


                        <template is="dom-if" if="{{artist.albums.songs.runtime.length}}">
                            <article>Runtime: {{artist.albums.songs.runtime}}</article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.format.length}}">
                            <article>Format:
                                <template is="dom-repeat" items="{{artist.albums.songs.format}}" as="format">
                                    <a href="#/search/format/{{_encodeUri(format)}}">{{format}}</a>
                                </template>
                            </article>
                        </template>





                        <template is="dom-if" if="{{artist.albums.songs.genre.length}}">
                            <article>
                                Genre:
                                <template is="dom-repeat" items="{{artist.albums.songs.genre}}" as="genre">
                                    <a href="#/search/genre/{{_encodeUri(genre)}}">{{genre}}</a>
                                </template>
                            </article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.producer.length}}">
                            <article>
                                Producer:
                                <template is="dom-repeat" items="{{artist.albums.songs.producer}}" as="producer">
                                    <a href="#/search/producer/{{_encodeUri(producer)}}">{{producer}}</a>
                                </template>
                            </article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.recordLabel.length}}">
                            <article>
                                RecordLabel:
                                <template is="dom-repeat" items="{{artist.albums.songs.recordLabel}}" as="recordLabel">
                                    <a href="#/search/recordlabel/{{_encodeUri(recordLabel)}}">{{recordLabel}}</a>
                                </template>
                            </article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.writer.length}}">
                            <article>Writer:
                                <template is="dom-repeat" items="{{artist.albums.songs.writer}}" as="writer">
                                    <a href="#/search/writer/{{_encodeUri(writer)}}">{{writer}}</a>
                                </template>
                            </article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.recorded.length}}">
                            <article>Recorded:
                                <template is="dom-repeat" items="{{artist.albums.songs.recorded}}" as="recorded">
                                    <a href="#/search/recorded/{{_encodeUri(recorded)}}">{{recorded}}</a>
                                </template>
                            </article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.releaseDate.length}}">
                            <article>Release Date: {{artist.albums.songs.releaseDate}}</article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.award.length}}">
                            <article>Award:
                                <template is="dom-repeat" items="{{artist.albums.songs.award}}" as="award">
                                    <a href="#/search/award/{{_encodeUri(award)}}">{{award}}</a>
                                </template>
                            </article>
                        </template>
                        <template is="dom-if" if="{{artist.albums.songs.abstract.length}}">
                            <p>Abstract: {{artist.albums.songs.abstract}}</p>
                        </template>
                    </section>
                    <section id="updateData">
                        <paper-fab hidden={{editing}}  icon="icons:create" on-tap="doEdit" class="edit" mini></paper-fab>
                        <paper-fab hidden={{!editing}} icon="icons:done"   on-tap="doEdit" class="done" mini></paper-fab>
                    </section>

                    <section id="songLyricsSection">
                        <article id="songLyricsNonEditable" hidden={{editing}} contenteditable=false> </article>
                        <article id="songLyricsEditable"  hidden={{!editing}} contenteditable=true> </article>
                    </section>
                    <nav>
                        <template is="dom-if" if="{{artist.albums.songs.subject.length}}">
                            <template is="dom-repeat" items="{{artist.albums.songs.subject}}" as="subject">
                                <a href="#/search/category/song/{{_encodeUri(subject)}}"> {{subject}}</a>
                            </template>
                        </template>
                    </nav>
                </div>
                <template is="dom-if" if="{{artist.albums.songs.multitrack_path.length}}">
                    <div>
                        <iframe id="frameMT5" style="width:100%; height:1000px" src="MT5/index.html" on-load="onFrameLoaded"></iframe>
                    </div>
                </template>
            </iron-pages>
        </paper-material>
    </template>
    <script>
        // element registration
        Polymer({
            is: "page-song",
            // add properties and methods on the element's prototype
            properties: {
                artist:{
                    type: Object,
                },
                idxCurrentTab:{
                    type:Number,
                    value:0,
                },
                editing: {
                    type: Boolean,
                    value: false
                }
            },
            getURLSongId : function(){
                return "/search/artist_id/"+this.artist._id+"/album_id/"+this.artist.albums._id+"/song_id/"+this.artist.albums.songs._id;
            },
            getURLSong: function(){
                return "/search/artist/"+this._encodeUri(this.artist.name)+"/album/"+this._encodeUri(this.artist.albums.title)+"/song/"+this._encodeUri(this.artist.albums.songs.title);
            },
            ready: function(){
                this.$.songLyricsEditable.addEventListener("paste", function(e) {
                    e.preventDefault();
                    var text = e.clipboardData.getData("text/plain");
                    text = text.replace(/\n|\r\n|\r/g, "<br>");
                    var cleanText = text.replace(/(<([^>]+)>)/ig, "<br>");//pour échapper éventuellement du html ou script
                    this.innerHTML = cleanText;
                });
            },
            _encodeUri : function(title){
                return encodeURIComponent(title);
            },
            //Cette fonction est utilisé lorsque l'utilisateur charge la page et lorsqu'il clique sur le bouton de modification des lyrics
            handleResponse: function(request) {
                //Si l'utilisateur clique sur le bouton de modification des lyrics
                if(this.editing){
                    //On ajoute via innerHTML les lyrics car nous récupérons du HTML en base de données (des balises <br>) cela nous permet de garder la mise en page
                    //Nous ne pouvons donc pas bind les lyrics directement dans le html du template
                    this.$.songLyricsEditable.innerHTML = this.artist.albums.songs.lyrics;
                }
                //Si l'utilisateur l'utilisateur veut sauvegarder ses modifications
                else{
                    this.$.songLyricsNonEditable.innerHTML = this.artist.albums.songs.lyrics;
                    /*On rempli aussi le contenu éditable (#songLyricsEditable) cela permet de ne pas avoir des lyrics vide lors de l'attente de la reponse ajax*/
                    this.$.songLyricsEditable.innerHTML = this.artist.albums.songs.lyrics;
                }
            },
            _concat: function(str1,str2){
                return this._encodeUri(str1+' '+str2);
            },
            //Lorsque l'utilisateur clique sur le bouton de modification ou de sauvegarde
            doEdit: function(e){
                this.editing=!this.editing;
                //lorsque l'utilisateur clique sur l'icone de modification
                if(this.editing){
                    //on récupére les infos en fonction de l'id de l'artiste/album/musique
                    this.$.get_content.url = this.getURLSongId();
                    this.$.get_content.generateRequest();
                }
                //Si l'utilisateur veut enregistrer ses modifications
                else{
                    //1er replace : On replace dans un premier temps les <div> (chrome) et <p> (firefox) du contenteditable correspondant au saut de ligne par des <br>
                    //2eme replace :On supprime ensuite les retours chariots et les autres tags HTML de l'utilisateur
                    this.$.songLyricsNonEditable.innerHTML = this.$.songLyricsEditable.innerHTML.replace(/<div>|<p>/ig,"<br>").replace(/\\n|\\r|\\r\\n|(<((?!br)[^>]+)>)/ig,"");
                    //Construction du body pour l'envoie des lyrics, on doit envoyer le html afin de garder la bonne mise en page
                    this.artist.albums.songs.lyrics = this.$.songLyricsNonEditable.innerHTML;
                    this.$.put_content.body = JSON.stringify(this.artist.albums.songs);
                    //Construction de la requête
                    this.$.put_content.url = this.getURLSong();
                    //On lance la requête
                    this.$.put_content.generateRequest();
                    //Si des modifications on eu lieu alors il faudra envoyé la requête ajax
//                    if(this.artist.albums.songs.lyrics != this.$.songLyricsNonEditable.innerHTML){ console.log("Des modifications"); } else{console.log("Pas de modifications"); }
                }
            },
            doIsClassic: function(){
                //Permet garder le binding lors de la modification d'un attribut profond
                this.set('artist.albums.songs.isClassic', !this.artist.albums.songs.isClassic);
                this.$.put_content.body = {
                    "_id":      this.artist.albums.songs._id,
                    "isClassic":this.artist.albums.songs.isClassic
                };
                this.$.put_content.url = this.getURLSong();
                this.$.put_content.generateRequest();
            },
            //  /!\ si <template is="dom-if" if="{{artist.albums.songs.multitrack_path.length}}"> est supprimé il y a une change que la frame soit charger
            //avant que la requête soit arrivée
            onFrameLoaded: function(){
                //Si la requête ajax a été recue avant la fin du chargement de l'iframe
                this.fire('firedataiframe', {song: this.artist.albums.songs});
            }
        });
    </script>
</dom-module>