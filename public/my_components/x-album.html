<!DOCTYPE html>
<html>
    <head>
        <link href="../bower_components/polymer/polymer.html" rel="import">
        <link href="../bower_components/paper-card/paper-card.html" rel="import">
        <link href="../bower_components/paper-button/paper-button.html" rel="import">
        <link href="../bower_components/iron-icon/iron-icon.html" rel="import">
        <link href="../bower_components/paper-ripple/paper-ripple.html" rel="import">
        <link rel="import" href="../bower_components/paper-fab/paper-fab.html">
    </head>

    <dom-module id="x-album">
        <style>
            .done {
                background: green;
            }
            paper-card.album, paper-fab{
                display: inline-block;
            }
            article{
               border-bottom: 1px solid #e5e5e5; 
            }
            .album{
                font-size: 22px;
                font-weight: 400;
                line-height: 28px;
                padding: 4%;
                height: 100px;
            }
            .flex-wrap {
                @apply(--layout-horizontal);
                @apply(--layout-wrap);
            }
            ol{
                list-style-position:inside; 
                margin: 0px;
                padding: 0px;
            }
            .songs{
                border-bottom: 1px solid rgba(229, 229, 229, 0.51);
                padding: 20px;
                padding-left: 7%;
                display: block;
            }
            paper-input{
                font-size: 22px;
                font-weight: 400;
                line-height: 28px;
                padding: 4%;
                height: 24px;
                margin-left: 2%;
                display: inline-block;
            }
            paper-fab{
                float: right;
                margin: 3%;
            }
            paper-card{
                cursor:pointer;
            }
            .addSong{
                margin: 4% 0% 1% 9%;
                background: rgb(63, 81, 181);
                color: white;
            }

        </style>
        <template>
            <iron-ajax id="get_content" method="GET" on-response="responseHandler" last-response="{{data}}" handleAs="json"> </iron-ajax>
            <iron-ajax id="put_content" method="PUT" content-type="application/json" last-response="{{response}}"></iron-ajax>
            <article>
               
                <paper-card on-tap="doLoadAlbum" link="#/search/artist/{{_encodeUri(artist.name)}}/album/{{_encodeUri(album.titre)}}"  hidden="{{editing}}" class="album" elevation="0">
                        Album:  {{album.titre}} {{album.dateSortie}}
                    <paper-ripple></paper-ripple>
                </paper-card> 
                
                <paper-input label="Nom de l'album" id="editTitre" hidden="{{!editing}}" value="{{album.titre}}"></paper-input>
                <paper-input label="Date de sortie" id="editDateSortie" hidden="{{!editing}}" value="{{album.dateSortie}}"></paper-input>

                <paper-fab hidden={{editing}}  icon="icons:create" on-tap="doEdit" class="edit" mini></paper-fab>
                <paper-fab hidden={{!editing}} icon="icons:done"   on-tap="doEdit" class="done" mini></paper-fab>

            </article>
            <div role="listbox">
                <ol id="listSong">
                <template id="songs" class="flex-wrap" is="dom-repeat" items="{{album.songs}}" as="song">
                    <x-song artist={{artist}} album={{album}} editing={{editing}} song={{song}}></x-song>
                </template>
                </ol>
            </div>
            <paper-button class="addSong"on-tap="addSong" hidden="{{!editing}}" raised elevation="2">
                Ajouter une musique 
                <iron-icon icon="add"></iron-icon>
            </paper-button>
        </template>
    </dom-module>

    
<script>
  // element registration
  Polymer({
    is: "x-album",
    // add properties and methods on the element's prototype
    properties: {
        album:{
            type: Object,
            value: {},
            notify: true,
            reflectToAttribute: true,
        },
        artist:{
            type: Object,
            value: {}
        },
    	editing: {
	    	type: Boolean,
	    	value: false	
    	},
        data:{
            type: Object,
            value: {},
        },
    },
    ready: function(e){    
    },
    doLoadAlbum:function(e){
      window.location.href = e.target.link;
    },
    addSong:function(e){
        var xsong = document.createElement("x-song");
        xsong.artist = this.artist;    
        xsong.album = this.album;
        xsong.editing = this.editing;
        Polymer.dom(this.$.listSong).appendChild(xsong);
        
    },
    doEdit: function(e){
    	this.editing=!this.editing;
        if(this.editing){  
            this.$.get_content.url = "/search/artist/"+this._encodeUri(this.artist.name)+"/album/"+this._encodeUri(this.album.titre); 
            console.log("URL DE L'ALBUM A MODIFIER :"+this.$.get_content.url);
            this.$.get_content.generateRequest();
        }
    	if (!this.editing){
            console.log("DANS !THIS EDITING");
            this.$.put_content.body = JSON.stringify(this.album);
            this.$.put_content.url = "/search/artist/"+this._encodeUri(this.artist.name)+"/album/"+this._encodeUri(this.album.titre);
            this.$.put_content.generateRequest();
        }
	},
    responseHandler: function(response){
        console.log("Requete fini");
        this.album = {};
        this.album = this.data.albums;
        
    },
    _encodeUri : function(titre){
        return encodeURIComponent(titre);
    }  
  });  

</script>   
</html>
    
