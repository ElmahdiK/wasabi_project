<!-- IMPORTS -->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<!-- MODULE -->
<dom-module id="show-feedback">
    <template>
        <!-- CSS -->
        <style>
            paper-button {
                margin: 1%;
                background-color: #3f51b5;
                color: white;
            }

            section#section_feedback {
                display: flex;
                flex-direction: row;
                justify-content: flex-start;
                align-items: flex-end;

                position: fixed;
                bottom: 130px;
                right: -400px;
                transition: 0.5s;

                z-index: 9;
            }

            section#section_feedback article {
                background: #3f51b5;
                box-shadow: 0px 2px 5px #ccc;

                display: flex;
                flex-direction: column;
                justify-content: flex-start;
                align-items: flex-end;

                padding: 5px;
                width: 400px;
            }

            section#section_feedback #bt_feedback {
                word-wrap: break-word;
            }

            section#section_feedback article textarea,
            button {
                padding: 10px;
                font-size: 16px;
            }

            section#section_feedback article textarea:focus {
                background: rgba(255, 255, 255, 1);
            }

            section#section_feedback article textarea {
                background: rgba(255, 255, 255, 0.8);

                height: 200px;
                max-height: 200px;
                transition: 0.5s;
                flex: 1;

                align-self: stretch;
                resize: vertical;
            }
        </style>

        <!-- HTML -->
        <section id="section_feedback">
            <paper-button id="bt_feedback" raised role="button" class="style-scope x-scope paper-button-0 bt_feedback" on-tap="viewFeedback">{{labelbuttonFeedback}}</paper-button>
            <article>
                <textarea id="text_feedback" placeholder="Your feedback here ..."></textarea>
                <paper-button id="bt_sendFeedback" raised role="button" class="style-scope x-scope paper-button-0 bt_feedback" on-tap="sendFeedback">{{labelbuttonSend}}</paper-button>
            </article>
        </section>
        <paper-toast id="info_message" text="Thank you. Your feedback was sended !" duration="5000" class="fit-bottom"></paper-toast>
    </template>

    <!-- JS -->
    <script>
        // element registration
        Polymer({
            is: "show-feedback",
            // add properties and methods on the element's prototype
            properties: {
                labelbuttonFeedback: {
                    type: String,
                    value: "feedback"
                },
                labelbuttonSend: {
                    type: String,
                    value: "envoyer",
                },
                feedBackOpen: {
                    type: Boolean,
                    value: false
                }
            },
            ready: function (e) { },
            sendFeedback: function () {
                if (this.$.text_feedback.value) {

                    let d = new Date();
                    //let datetime = d.getFullYear() + "/" + (d.getMonth() + 1) + "/" + d.getDate() + " " + d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds();
                    let datetime=d.toLocaleString();
                    let _feedbackMsg = (datetime + " : " + (window.location.href) + "\n-----\n=> " + this.$.text_feedback.value + "\n------------------------------------\n");
                     
                    let http = new XMLHttpRequest();
                    let url = "/feedback/";
                    let params = "feedbackMsg=" + _feedbackMsg;
                    http.open("POST", url, true);

                    //Send the proper header information along with the request
                    //http.setRequestHeader("Content-Type", "application/json");
                    http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

                    http.onreadystatechange =  ()=> {//Call a function when the state changes.
                        if (http.readyState == 4 && http.status == 200) {
                            //console.log(http.responseText);
                            this.$.info_message.open();
                        }
                    }
                    http.send(params);
                }
            },
            viewFeedback: function () {
                if (!this.feedBackOpen) {
                    this.$.bt_feedback.innerText = "close";
                    this.$.section_feedback.style.right = "15px";
                } else {
                    this.$.bt_feedback.innerText = "feedback";
                    this.$.section_feedback.style.right = "-400px";
                }
                this.feedBackOpen = !this.feedBackOpen;
            }
        });
    </script>
</dom-module>