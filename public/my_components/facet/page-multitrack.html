<link href="../../bower_components/polymer/polymer.html" rel="import">
<link href="../../bower_components/iron-ajax/iron-ajax.html" rel="import">
<link href="../../bower_components/paper-material/paper-material.html" rel="import">
<link href="../../bower_components/paper-button/paper-button.html" rel="import">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">




<dom-module id="page-multitrack">
    <template>
        <style>
            .app_content{

                width:100%;
                margin:0 auto;

            }
            .searchText-info {
                font-size: 1.5em;
                padding: 25px;
                color: #333333;
                text-align: center;
            }

            #ul_content {
                background: linear-gradient(#fafafa,#fff);
                box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);

                list-style: none;
                margin: 0px !important;
                padding: 0px !important;
            }

            #ul_content li {
            }

            #ul_content li a:hover {
                background: #3f51b5;
                color: #fff;
                text-indent: 5px;
            }

            #ul_content li a {
                color: #111;
                border-bottom: 1px solid #ddd;

                padding: 20px;

                display: block;
                text-decoration: none;
                transition: 0.5s;
            }


            .app_pagination {
                background: #3f51b5;

                display: flex;
                flex-direction: row;
                justify-content: center;
                position: relative;

                margin: 0 auto;
                padding: 10px;
                margin-top: 50px;
            }

            .app_pagination paper-button:hover {
                color: #fff;
            }

            .app_pagination paper-button {
                color: #aaa;
            }

            .hidden {
                display: none;
            }

            .img_loading {
                height: 50px;
                vertical-align: middle;
            }

            #img_loading {
                position: absolute;
                left: 0px;
                top: 7px;
            }
        </style>

        <iron-ajax id="get_count" on-response='_countFinished' auto url="/search/song/count/multitrack" last-response="{{countField}}"
            handleAs="json"></iron-ajax>

        <div class="app_content">
            <p class="center searchText-info">We have
                <template id="templateForm" is="dom-if" if="{{!indicator}}">
                    <img class='img_loading' src="http://backgroundcheckall.com/wp-content/uploads/2017/12/loading-gif-transparent-background-6.gif">
                </template>
                <template id="templateForm" is="dom-if" if="{{indicator}}">
                    <b>{{indicator}}</b>
                </template>
                multitrack songs
            </p>
            <ul id="ul_content"></ul>
            <div id="app_pagination" class="app_pagination hidden">
                <img id='img_loading' class='img_loading' src="http://backgroundcheckall.com/wp-content/uploads/2017/12/loading-gif-transparent-background-6.gif">

                <paper-button id='bt_first'>first</paper-button>
                <paper-button id='bt_previous'>previous</paper-button>
                <paper-button id='bt_next'>next</paper-button>
                <paper-button id='bt_last'>last</paper-button>
            </div>
        </div>
    </template>

    <script>
        // element registration
        Polymer({
            is: "page-multitrack",
            // add properties and methods on the element's prototype
            properties: {
                pagination: {
                    type: Object,
                    value: null
                },
                indicator: {
                    type: Object,
                    value: null
                }
            },
            ready: function (e) {
                console.log('ready');

                let _ul_content = this.$.ul_content;
                let _img_loading = this.$.img_loading;

                this.pagination = new Pagination(_ul_content, `/search/song/multitrack/`, _img_loading);

                let _bt_first = this.$.bt_first;
                let _bt_previous = this.$.bt_previous;
                let _bt_next = this.$.bt_next;
                let _bt_last = this.$.bt_last;

                _bt_first.onclick = () => this.pagination.first();
                _bt_previous.onclick = () => this.pagination.previous();
                _bt_next.onclick = () => this.pagination.next();
                _bt_last.onclick = () => this.pagination.last();
            },
            _updateReq: function (_num) {
                this.$.get_content.url = `/search/song/multitrack/${_num}`;
                this.$.get_content.generateRequest();
            },
            _countFinished: function (e) {
                const _nbSongs = e.detail.response.count;
                this.pagination.lastPage = parseInt(_nbSongs / 10);
                this.$.app_pagination.classList.remove('hidden');

                this.indicator = _nbSongs;
            }
        });


        class Pagination {
            constructor(_container, _urlAPI, _indicator) {
                this.container = _container;
                this.indicator = _indicator;

                this.page = 1;
                this.lastPage = 1;
                this.nbPageViews = 2;

                this.urlAPI = _urlAPI;
                this.getAPIResults();
            }

            getAPIResults() {
                this.indicator.style.display = "flex";
                fetch(`${this.urlAPI + this.page}`).
                    then(response => {
                        response.json().then(res => {
                            let _listHTML = "";
                            Object.keys(res).map(
                                (elem, index) => {
                                    _listHTML += this.render(res[elem]);
                                }
                            )
                            this.container.innerHTML = _listHTML;
                            this.indicator.style.display = "none";
                        })
                    })
            }

            first() {
                if (this.page != 1) {
                    this.page = 1;
                    this.getAPIResults();
                }
            }

            last() {
                if (this.page != this.lastPage) {
                    this.page = this.lastPage;
                    this.getAPIResults();
                }
            }

            next() {
                if (this.page < this.lastPage) {
                    this.page += 1;
                    this.getAPIResults();
                }
            }

            previous() {
                if (this.page > 1) {
                    this.page -= 1;
                    this.getAPIResults();
                }
            }

            _encodeUri(nameArtist) {
                return encodeURIComponent(nameArtist);
            }

            render(data) {
                return `
                <li class="style-scope page-multitrack">
                    <a href="#/search/artist/${this._encodeUri(data.name)}/album/${this._encodeUri(data.albumTitle)}/song/${this._encodeUri(data.title)}" class="style-scope page-multitrack">
                        <u>${(data.title)}</u> - <i>${(data.albumTitle)}</i> by <b>${(data.name)}</b>
                        </a>
                        </li>`;
            }
        }
    </script>
</dom-module>